# åŒ»è¯å¸‚åœºæ™ºèƒ½åˆ†æç³»ç»Ÿ - Agentå¼€å‘æ€»æç¤ºè¯

> **ç›®æ ‡**ï¼šæŒ‡å¯¼AI Agentå¼€å‘ä¸€ä¸ªå®Œæ•´çš„åŸºäºLLMæ™ºèƒ½ä½“çš„åŒ»è¯å¸‚åœºåˆ†æç³»ç»Ÿ
> **æŠ€æœ¯æ ˆ**ï¼šFastAPI + Vue3 + SQLite + Dify + K-Means
> **å¼€å‘æ¨¡å¼**ï¼šæ¨¡å—åŒ–å¼€å‘ï¼Œå‰åç«¯åˆ†ç¦»ï¼Œè¿­ä»£äº¤ä»˜

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

ä½ æ˜¯ä¸€ä¸ªèµ„æ·±å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆï¼Œè´Ÿè´£å¼€å‘ä¸€ä¸ªåŒ»è¯å¸‚åœºæ™ºèƒ½åˆ†æç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ï¼š

1. **ç”¨æˆ·è®¤è¯ä¸æƒé™ç®¡ç†**ï¼šæ”¯æŒæ³¨å†Œã€ç™»å½•ã€è§’è‰²æƒé™
2. **åŒ»ç”Ÿæ•°æ®ç®¡ç†**ï¼šæŸ¥è¯¢ã€ç­›é€‰ã€ç»Ÿè®¡738,772ååŒ»ç”Ÿçš„RFMæ•°æ®
3. **K-Meansèšç±»åˆ†æ**ï¼šè‡ªåŠ¨å°†åŒ»ç”Ÿåˆ†ç¾¤ï¼Œç”Ÿæˆå¯è§†åŒ–å›¾è¡¨
4. **AIæ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ**ï¼šé€šè¿‡Difyå·¥ä½œæµï¼Œè‡ªåŠ¨ç”Ÿæˆå¸‚åœºç­–ç•¥æŠ¥å‘Š
5. **æ•°æ®çœ‹æ¿**ï¼šå±•ç¤ºå…³é”®ä¸šåŠ¡æŒ‡æ ‡å’Œè¶‹åŠ¿

## ğŸ“‹ å¼€å‘åŸåˆ™

### åŸåˆ™1ï¼šä»£ç è´¨é‡ä¼˜å…ˆ

- æ¯ä¸ªå‡½æ•°/ç»„ä»¶éƒ½è¦æœ‰æ¸…æ™°çš„ç±»å‹æ³¨è§£ï¼ˆPython/TypeScriptï¼‰
- éµå¾ªRESTful APIè®¾è®¡è§„èŒƒ
- é”™è¯¯å¤„ç†è¦å®Œå–„ï¼Œç»™å‡ºæ˜ç¡®çš„é”™è¯¯æç¤º
- ä»£ç æ³¨é‡Šè¦è¯¦ç»†ï¼Œç‰¹åˆ«æ˜¯å¤æ‚é€»è¾‘éƒ¨åˆ†

### åŸåˆ™2ï¼šç”¨æˆ·ä½“éªŒè‡³ä¸Š

- æ‰€æœ‰æ“ä½œè¦æœ‰LoadingçŠ¶æ€
- æ•°æ®åŠ è½½å¤±è´¥è¦æœ‰å‹å¥½çš„é”™è¯¯é¡µé¢
- ä½¿ç”¨åŠ¨ç”»å¢å¼ºäº¤äº’ä½“éªŒï¼ˆä½†ä¸è¦è¿‡åº¦ï¼‰
- ç§»åŠ¨ç«¯è¦å“åº”å¼é€‚é…

### åŸåˆ™3ï¼šæ€§èƒ½ä¼˜åŒ–

- åˆ—è¡¨æŸ¥è¯¢è¦æ”¯æŒåˆ†é¡µå’Œæ‡’åŠ è½½
- å›¾è¡¨æ•°æ®è¦æŒ‰éœ€åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§ä¼ è¾“å¤§é‡æ•°æ®
- ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§åˆ—è¡¨
- é™æ€èµ„æºè¦CDNåŠ é€Ÿ

### åŸåˆ™4ï¼šå®‰å…¨æ€§

- å¯†ç è¦ç”¨bcryptåŠ å¯†å­˜å‚¨
- JWT Tokenè¦è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- APIè¦æœ‰æƒé™æ ¡éªŒ
- é˜²æ­¢SQLæ³¨å…¥å’ŒXSSæ”»å‡»

---

## ğŸ”§ æŠ€æœ¯å®ç°æŒ‡å—

### ç¬¬ä¸€éƒ¨åˆ†ï¼šåç«¯å¼€å‘ (FastAPI)

#### 1.1 é¡¹ç›®åˆå§‹åŒ–

**ä»»åŠ¡**ï¼šæ­å»ºFastAPIé¡¹ç›®éª¨æ¶

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install fastapi uvicorn sqlalchemy pydantic bcrypt python-jose pandas scikit-learn httpx
```

**ç›®å½•ç»“æ„**ï¼š

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ config.py            # é…ç½®
â”‚   â”œâ”€â”€ database.py          # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ models/              # SQLAlchemyæ¨¡å‹
â”‚   â”œâ”€â”€ schemas/             # Pydanticæ¨¡å‹
â”‚   â”œâ”€â”€ routers/             # APIè·¯ç”±
â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒæ¨¡å—ï¼ˆå®‰å…¨ã€å¼‚å¸¸ï¼‰
â”‚   â””â”€â”€ dify_tools/          # Difyå·¥å…·
â”œâ”€â”€ scripts/                 # è„šæœ¬
â””â”€â”€ pharma.db                # æ•°æ®åº“æ–‡ä»¶
```

#### 1.2 æ•°æ®åº“æ¨¡å‹å®šä¹‰

**ä»»åŠ¡**ï¼šåˆ›å»º7å¼ æ ¸å¿ƒè¡¨çš„SQLAlchemyæ¨¡å‹

**å…³é”®ä»£ç ç¤ºä¾‹**ï¼š

```python
# app/models/user.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.sql import func
from app.database import Base

class User(Base):
    __tablename__ = "users"
  
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False, index=True)
    password_hash = Column(String(255), nullable=False)
    full_name = Column(String(100))
    role = Column(String(20), default="viewer")  # admin/analyst/viewer
    avatar_url = Column(String(255))
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    last_login = Column(DateTime(timezone=True))
```

**è¦å®ç°çš„æ¨¡å‹**ï¼š

1. `User` - ç”¨æˆ·è¡¨
2. `Doctor` - åŒ»ç”Ÿè¡¨ï¼ˆæ‰©å±•ç°æœ‰å­—æ®µï¼‰
3. `PaymentRecord` - æ”¯ä»˜è®°å½•è¡¨
4. `AnalysisTask` - åˆ†æä»»åŠ¡è¡¨
5. `ClusterResult` - èšç±»ç»“æœè¡¨
6. `AIReport` - AIæŠ¥å‘Šè¡¨
7. `SystemLog` - ç³»ç»Ÿæ—¥å¿—è¡¨

#### 1.3 è®¤è¯ç³»ç»Ÿå®ç°

**ä»»åŠ¡**ï¼šå®ç°JWT Tokenè®¤è¯

**å…³é”®æ­¥éª¤**ï¼š

1. åˆ›å»º `app/core/security.py`ï¼š

   - `get_password_hash()` - bcryptå¯†ç å“ˆå¸Œ
   - `verify_password()` - éªŒè¯å¯†ç 
   - `create_access_token()` - ç”ŸæˆJWT
   - `get_current_user()` - éªŒè¯å¹¶è·å–å½“å‰ç”¨æˆ·
2. åˆ›å»º `app/routers/auth.py`ï¼š

   - `POST /api/v1/auth/register` - æ³¨å†Œ
   - `POST /api/v1/auth/login` - ç™»å½•
   - `GET /api/v1/auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
   - `POST /api/v1/auth/logout` - ç™»å‡º

**ç¤ºä¾‹ä»£ç **ï¼š

```python
# app/core/security.py
from passlib.context import CryptContext
from jose import JWTError, jwt
from datetime import datetime, timedelta

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
SECRET_KEY = "your-secret-key-here"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 1440  # 24å°æ—¶

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
```

#### 1.4 åŒ»ç”Ÿæ•°æ®API

**ä»»åŠ¡**ï¼šå®ç°åŒ»ç”Ÿæ•°æ®çš„CRUDæ¥å£

**APIåˆ—è¡¨**ï¼š

```python
# app/routers/doctors.py
@router.get("/doctors")
async def get_doctors(
    page: int = 1,
    page_size: int = 20,
    specialty: Optional[str] = None,
    state: Optional[str] = None,
    cluster_id: Optional[int] = None,
    min_monetary: Optional[float] = None,
    db: Session = Depends(get_db)
):
    """åˆ†é¡µæŸ¥è¯¢åŒ»ç”Ÿåˆ—è¡¨ï¼Œæ”¯æŒå¤šæ¡ä»¶ç­›é€‰"""
    # æ„å»ºæŸ¥è¯¢
    query = db.query(Doctor)
  
    if specialty:
        query = query.filter(Doctor.specialty == specialty)
    if state:
        query = query.filter(Doctor.state == state)
    if cluster_id is not None:
        query = query.filter(Doctor.cluster_id == cluster_id)
    if min_monetary:
        query = query.filter(Doctor.rfm_monetary >= min_monetary)
  
    # åˆ†é¡µ
    total = query.count()
    doctors = query.offset((page - 1) * page_size).limit(page_size).all()
  
    return {
        "code": 200,
        "data": {
            "total": total,
            "page": page,
            "page_size": page_size,
            "items": doctors
        }
    }

@router.get("/doctors/{npi}")
async def get_doctor_detail(npi: str, db: Session = Depends(get_db)):
    """è·å–åŒ»ç”Ÿè¯¦æƒ…ï¼ŒåŒ…æ‹¬æ”¯ä»˜å†å²"""
    doctor = db.query(Doctor).filter(Doctor.npi == npi).first()
    if not doctor:
        raise HTTPException(status_code=404, detail="Doctor not found")
  
    # è·å–æœ€è¿‘10æ¡æ”¯ä»˜è®°å½•
    payments = db.query(PaymentRecord)\
        .filter(PaymentRecord.npi == npi)\
        .order_by(PaymentRecord.payment_date.desc())\
        .limit(10)\
        .all()
  
    return {
        "code": 200,
        "data": {
            "doctor": doctor,
            "recent_payments": payments
        }
    }

@router.get("/doctors/statistics")
async def get_statistics(db: Session = Depends(get_db)):
    """è·å–åŒ»ç”Ÿæ•°æ®ç»Ÿè®¡"""
    total_doctors = db.query(Doctor).count()
    total_monetary = db.query(func.sum(Doctor.rfm_monetary)).scalar()
    avg_monetary = db.query(func.avg(Doctor.rfm_monetary)).scalar()
  
    # ä¸“ä¸šåˆ†å¸ƒ
    specialty_dist = db.query(
        Doctor.specialty, 
        func.count(Doctor.npi)
    ).group_by(Doctor.specialty).all()
  
    return {
        "code": 200,
        "data": {
            "total_doctors": total_doctors,
            "total_monetary": float(total_monetary),
            "avg_monetary": float(avg_monetary),
            "specialty_distribution": dict(specialty_dist)
        }
    }
```

#### 1.5 K-Meansèšç±»æœåŠ¡

**ä»»åŠ¡**ï¼šå°è£…K-Meansç®—æ³•ä¸ºæœåŠ¡

**å…³é”®ä»£ç **ï¼š

```python
# app/services/analysis_service.py
import pandas as pd
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import silhouette_score
import json

class AnalysisService:
    def __init__(self, db: Session):
        self.db = db
  
    def perform_clustering(self, k: int = 3, features: list = None):
        """æ‰§è¡ŒK-Meansèšç±»"""
        # 1. ä»æ•°æ®åº“åŠ è½½æ•°æ®
        doctors = self.db.query(Doctor).all()
        df = pd.DataFrame([{
            'npi': d.npi,
            'rfm_frequency': d.rfm_frequency,
            'rfm_monetary': d.rfm_monetary
        } for d in doctors])
      
        # 2. ç‰¹å¾æ ‡å‡†åŒ–
        if features is None:
            features = ['rfm_frequency', 'rfm_monetary']
      
        X = df[features].values
        scaler = StandardScaler()
        X_scaled = scaler.fit_transform(X)
      
        # 3. æ‰§è¡Œèšç±»
        kmeans = KMeans(n_clusters=k, random_state=42, n_init=10)
        labels = kmeans.fit_predict(X_scaled)
      
        # 4. è®¡ç®—è¯„ä¼°æŒ‡æ ‡
        silhouette = silhouette_score(X_scaled, labels)
        inertia = kmeans.inertia_
      
        # 5. è®¡ç®—æ¯ä¸ªèšç±»çš„ç»Ÿè®¡ä¿¡æ¯
        df['cluster'] = labels
        cluster_stats = {}
      
        for cluster_id in range(k):
            cluster_df = df[df['cluster'] == cluster_id]
            cluster_stats[str(cluster_id)] = {
                'size': len(cluster_df),
                'avg_frequency': float(cluster_df['rfm_frequency'].mean()),
                'avg_monetary': float(cluster_df['rfm_monetary'].mean()),
                'label': self._generate_cluster_label(cluster_df)
            }
      
        # 6. ä¿å­˜èšç±»ç»“æœåˆ°æ•°æ®åº“
        cluster_result = ClusterResult(
            k_value=k,
            algorithm='k-means',
            features_used=json.dumps(features),
            cluster_stats=json.dumps(cluster_stats),
            silhouette_score=silhouette,
            inertia=inertia,
            is_active=True
        )
      
        # 7. æ›´æ–°åŒ»ç”Ÿè¡¨çš„cluster_id
        for _, row in df.iterrows():
            self.db.query(Doctor)\
                .filter(Doctor.npi == row['npi'])\
                .update({'cluster_id': int(row['cluster'])})
      
        self.db.add(cluster_result)
        self.db.commit()
      
        return cluster_result
  
    def _generate_cluster_label(self, cluster_df):
        """æ ¹æ®ç‰¹å¾è‡ªåŠ¨ç”Ÿæˆèšç±»æ ‡ç­¾"""
        avg_monetary = cluster_df['rfm_monetary'].mean()
        avg_frequency = cluster_df['rfm_frequency'].mean()
      
        if avg_monetary > 10000 and avg_frequency > 20:
            return "é¡¶çº§å®¢æˆ·"
        elif avg_monetary > 5000:
            return "æ ¸å¿ƒå®¢æˆ·"
        elif avg_monetary > 1000:
            return "æ½œåŠ›å®¢æˆ·"
        else:
            return "å¤§ä¼—å®¢æˆ·"
```

#### 1.6 Difyé›†æˆæœåŠ¡

**ä»»åŠ¡**ï¼šåˆ›å»ºDifyæœåŠ¡ï¼Œå®ç°AIæŠ¥å‘Šç”Ÿæˆ

**å…³é”®ä»£ç **ï¼š

```python
# app/services/dify_service.py
import httpx
from typing import AsyncGenerator
import os

class DifyService:
    def __init__(self):
        self.base_url = os.getenv("DIFY_API_URL", "https://api.dify.ai/v1")
        self.api_key = os.getenv("DIFY_API_KEY")
        self.workflow_id = os.getenv("DIFY_WORKFLOW_ID")
  
    async def generate_report_stream(
        self, 
        user_input: str,
        cluster_data: dict,
        user_id: int
    ) -> AsyncGenerator[str, None]:
        """æµå¼ç”ŸæˆæŠ¥å‘Š"""
        async with httpx.AsyncClient(timeout=300.0) as client:
            async with client.stream(
                "POST",
                f"{self.base_url}/workflows/run",
                json={
                    "inputs": {
                        "user_query": user_input,
                        "cluster_stats": cluster_data,
                        "user_context": f"analyst_{user_id}"
                    },
                    "response_mode": "streaming",
                    "user": f"user_{user_id}"
                },
                headers={
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
            ) as response:
                async for line in response.aiter_lines():
                    if line.startswith("data: "):
                        data = line[6:]  # å»æ‰ "data: " å‰ç¼€
                        if data == "[DONE]":
                            break
                        yield data + "\n"
```

**æŠ¥å‘Šç”ŸæˆAPI**ï¼š

```python
# app/routers/reports.py
from fastapi.responses import StreamingResponse

@router.post("/reports/generate")
async def generate_report(
    request: ReportGenerateRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """ç”ŸæˆAIæŠ¥å‘Šï¼ˆå¼‚æ­¥ï¼‰"""
    # 1. åˆ›å»ºæŠ¥å‘Šè®°å½•
    report = AIReport(
        report_title=request.title or "AIåˆ†ææŠ¥å‘Š",
        report_type=request.report_type,
        related_cluster_id=request.cluster_id,
        generated_by=current_user.id,
        status="generating"
    )
    db.add(report)
    db.commit()
    db.refresh(report)
  
    # 2. è·å–èšç±»æ•°æ®
    cluster = db.query(ClusterResult)\
        .filter(ClusterResult.cluster_id == request.cluster_id)\
        .first()
  
    cluster_data = json.loads(cluster.cluster_stats)
  
    # 3. è¿”å›æŠ¥å‘ŠIDï¼Œå‰ç«¯é€šè¿‡streamæ¥å£è·å–å†…å®¹
    return {
        "code": 200,
        "data": {
            "report_id": report.report_id,
            "status": "generating",
            "stream_url": f"/api/v1/reports/{report.report_id}/stream"
        }
    }

@router.get("/reports/{report_id}/stream")
async def stream_report(
    report_id: int,
    db: Session = Depends(get_db)
):
    """SSEæµå¼è¾“å‡ºæŠ¥å‘Šå†…å®¹"""
    report = db.query(AIReport).filter(AIReport.report_id == report_id).first()
    if not report:
        raise HTTPException(status_code=404)
  
    dify_service = DifyService()
  
    async def event_generator():
        full_content = ""
        async for chunk in dify_service.generate_report_stream(
            user_input=report.report_title,
            cluster_data={},  # ä»æ•°æ®åº“è·å–
            user_id=report.generated_by
        ):
            full_content += chunk
            yield f"data: {chunk}\n\n"
      
        # ä¿å­˜å®Œæ•´æŠ¥å‘Š
        report.report_content = full_content
        report.status = "published"
        db.commit()
      
        yield "data: [DONE]\n\n"
  
    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream"
    )
```

---

### ç¬¬äºŒéƒ¨åˆ†ï¼šå‰ç«¯å¼€å‘ (Vue3 + TypeScript)

#### 2.1 é¡¹ç›®åˆå§‹åŒ–

**ä»»åŠ¡**ï¼šä½¿ç”¨Viteåˆ›å»ºVue3é¡¹ç›®

```bash
npm create vite@latest frontend -- --template vue-ts
cd frontend
npm install

# å®‰è£…ä¾èµ–
npm install vue-router@4 pinia axios element-plus
npm install echarts vue-echarts
npm install @vueuse/core dayjs markdown-it
npm install sass -D
```

**é…ç½®Viteä»£ç†**ï¼š

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import path from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
})
```

#### 2.2 Axioså°è£…

**ä»»åŠ¡**ï¼šå°è£…HTTPè¯·æ±‚ï¼Œç»Ÿä¸€å¤„ç†é”™è¯¯å’ŒToken

```typescript
// src/utils/request.ts
import axios from 'axios'
import { ElMessage } from 'element-plus'
import { useUserStore } from '@/store/user'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api/v1',
  timeout: 30000
})

// è¯·æ±‚æ‹¦æˆªå™¨
request.interceptors.request.use(
  config => {
    const userStore = useUserStore()
    if (userStore.token) {
      config.headers.Authorization = `Bearer ${userStore.token}`
    }
    return config
  },
  error => Promise.reject(error)
)

// å“åº”æ‹¦æˆªå™¨
request.interceptors.response.use(
  response => {
    const { code, message, data } = response.data
  
    if (code === 200) {
      return data
    } else {
      ElMessage.error(message || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(message))
    }
  },
  error => {
    if (error.response?.status === 401) {
      const userStore = useUserStore()
      userStore.logout()
      ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
    } else {
      ElMessage.error(error.response?.data?.message || 'ç½‘ç»œé”™è¯¯')
    }
    return Promise.reject(error)
  }
)

export default request
```

#### 2.3 APIæ¨¡å—

**ä»»åŠ¡**ï¼šå°è£…æ‰€æœ‰APIè°ƒç”¨

```typescript
// src/api/auth.ts
import request from '@/utils/request'

export interface LoginForm {
  username: string
  password: string
}

export interface RegisterForm {
  username: string
  email: string
  password: string
  full_name?: string
}

export const authAPI = {
  // ç™»å½•
  login(data: LoginForm) {
    return request.post('/auth/login', data)
  },
  
  // æ³¨å†Œ
  register(data: RegisterForm) {
    return request.post('/auth/register', data)
  },
  
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  getCurrentUser() {
    return request.get('/auth/me')
  },
  
  // ç™»å‡º
  logout() {
    return request.post('/auth/logout')
  }
}

// src/api/doctor.ts
export interface DoctorQuery {
  page?: number
  page_size?: number
  specialty?: string
  state?: string
  cluster_id?: number
}

export const doctorAPI = {
  // è·å–åŒ»ç”Ÿåˆ—è¡¨
  getDoctors(params: DoctorQuery) {
    return request.get('/doctors', { params })
  },
  
  // è·å–åŒ»ç”Ÿè¯¦æƒ…
  getDoctorDetail(npi: string) {
    return request.get(`/doctors/${npi}`)
  },
  
  // è·å–ç»Ÿè®¡æ•°æ®
  getStatistics() {
    return request.get('/doctors/statistics')
  }
}

// src/api/analysis.ts
export interface ClusteringRequest {
  k: number
  features?: string[]
  task_name: string
}

export const analysisAPI = {
  // æ‰§è¡Œèšç±»
  performClustering(data: ClusteringRequest) {
    return request.post('/analysis/clustering/perform', data)
  },
  
  // è·å–èšç±»ç»“æœ
  getClusterResults(clusterId: number) {
    return request.get(`/analysis/clustering/results/${clusterId}`)
  },
  
  // è·å–ä»»åŠ¡çŠ¶æ€
  getTaskStatus(taskId: number) {
    return request.get(`/analysis/tasks/${taskId}/status`)
  }
}

// src/api/report.ts
export const reportAPI = {
  // ç”ŸæˆæŠ¥å‘Š
  generateReport(data: {
    report_type: string
    cluster_id: number
    custom_prompt?: string
  }) {
    return request.post('/reports/generate', data)
  },
  
  // è·å–æŠ¥å‘Šåˆ—è¡¨
  getReports(params: {
    page?: number
    page_size?: number
    report_type?: string
  }) {
    return request.get('/reports', { params })
  },
  
  // è·å–æŠ¥å‘Šè¯¦æƒ…
  getReportDetail(reportId: number) {
    return request.get(`/reports/${reportId}`)
  }
}
```

#### 2.4 PiniaçŠ¶æ€ç®¡ç†

**ä»»åŠ¡**ï¼šåˆ›å»ºç”¨æˆ·ã€åˆ†æã€æŠ¥å‘Šç­‰çŠ¶æ€

```typescript
// src/store/user.ts
import { defineStore } from 'pinia'
import { authAPI } from '@/api/auth'

interface User {
  id: number
  username: string
  email: string
  role: string
  avatar_url: string
}

export const useUserStore = defineStore('user', {
  state: () => ({
    token: localStorage.getItem('token') || '',
    user: null as User | null
  }),
  
  getters: {
    isLoggedIn: (state) => !!state.token,
    isAdmin: (state) => state.user?.role === 'admin'
  },
  
  actions: {
    async login(username: string, password: string) {
      const data = await authAPI.login({ username, password })
      this.token = data.access_token
      this.user = data.user
      localStorage.setItem('token', data.access_token)
    },
  
    async fetchUserInfo() {
      const data = await authAPI.getCurrentUser()
      this.user = data
    },
  
    logout() {
      this.token = ''
      this.user = null
      localStorage.removeItem('token')
    }
  }
})

// src/store/analysis.ts
export const useAnalysisStore = defineStore('analysis', {
  state: () => ({
    currentTask: null,
    clusterResults: null,
    isAnalyzing: false
  }),
  
  actions: {
    async startClustering(k: number, features: string[]) {
      this.isAnalyzing = true
      try {
        const data = await analysisAPI.performClustering({
          k,
          features,
          task_name: `K=${k}èšç±»åˆ†æ`
        })
        this.currentTask = data
      
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        return await this.pollTaskStatus(data.task_id)
      } finally {
        this.isAnalyzing = false
      }
    },
  
    async pollTaskStatus(taskId: number) {
      const poll = async () => {
        const data = await analysisAPI.getTaskStatus(taskId)
        if (data.status === 'completed') {
          this.clusterResults = await analysisAPI.getClusterResults(data.result_id)
          return this.clusterResults
        } else if (data.status === 'failed') {
          throw new Error(data.error_message)
        } else {
          await new Promise(resolve => setTimeout(resolve, 2000))
          return poll()
        }
      }
      return poll()
    }
  }
})
```

#### 2.5 æ ¸å¿ƒé¡µé¢å¼€å‘

##### 2.5.1 ç™»å½•é¡µ

```vue
<!-- src/views/auth/LoginView.vue -->
<template>
  <div class="login-container">
    <div class="login-left">
      <div class="brand">
        <img src="@/assets/logo.png" alt="Logo" class="logo" />
        <h1>åŒ»è¯å¸‚åœºæ™ºèƒ½åˆ†æç³»ç»Ÿ</h1>
        <p class="slogan">æ•°æ®é©±åŠ¨å†³ç­–ï¼Œæ™ºèƒ½èµ‹èƒ½åŒ»ç–—</p>
      </div>
    
      <!-- åŠ¨æ€èƒŒæ™¯åŠ¨ç”» -->
      <div class="bg-animation">
        <div class="particle" v-for="i in 20" :key="i"></div>
      </div>
    </div>
  
    <div class="login-right">
      <el-card class="login-card">
        <h2>ç”¨æˆ·ç™»å½•</h2>
      
        <el-form
          ref="formRef"
          :model="form"
          :rules="rules"
          @submit.prevent="handleLogin"
        >
          <el-form-item prop="username">
            <el-input
              v-model="form.username"
              placeholder="ç”¨æˆ·å"
              size="large"
              prefix-icon="User"
            />
          </el-form-item>
        
          <el-form-item prop="password">
            <el-input
              v-model="form.password"
              type="password"
              placeholder="å¯†ç "
              size="large"
              prefix-icon="Lock"
              show-password
            />
          </el-form-item>
        
          <el-form-item>
            <el-checkbox v-model="form.remember">è®°ä½æˆ‘</el-checkbox>
          </el-form-item>
        
          <el-form-item>
            <el-button
              type="primary"
              size="large"
              :loading="loading"
              native-type="submit"
              class="login-btn"
            >
              ç™»å½•
            </el-button>
          </el-form-item>
        
          <div class="footer-links">
            <router-link to="/register">æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</router-link>
          </div>
        </el-form>
      </el-card>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import { useUserStore } from '@/store/user'
import { ElMessage } from 'element-plus'

const router = useRouter()
const userStore = useUserStore()

const form = reactive({
  username: '',
  password: '',
  remember: false
})

const rules = {
  username: [
    { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' }
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' },
    { min: 6, message: 'å¯†ç é•¿åº¦è‡³å°‘6ä½', trigger: 'blur' }
  ]
}

const loading = ref(false)
const formRef = ref()

const handleLogin = async () => {
  await formRef.value.validate()
  loading.value = true
  
  try {
    await userStore.login(form.username, form.password)
    ElMessage.success('ç™»å½•æˆåŠŸ')
    router.push('/')
  } catch (error) {
    ElMessage.error('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ')
  } finally {
    loading.value = false
  }
}
</script>

<style scoped lang="scss">
.login-container {
  display: flex;
  height: 100vh;
  
  .login-left {
    flex: 1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  
    .brand {
      position: relative;
      z-index: 2;
      text-align: center;
    
      .logo {
        width: 120px;
        margin-bottom: 24px;
      }
    
      h1 {
        font-size: 32px;
        margin-bottom: 16px;
      }
    
      .slogan {
        font-size: 18px;
        opacity: 0.9;
      }
    }
  
    .bg-animation {
      position: absolute;
      inset: 0;
      overflow: hidden;
    
      .particle {
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 20s infinite;
      
        @for $i from 1 through 20 {
          &:nth-child(#{$i}) {
            width: random(60) + 20px;
            height: random(60) + 20px;
            left: random(100) * 1%;
            top: random(100) * 1%;
            animation-delay: random(20) * 0.1s;
          }
        }
      }
    }
  }
  
  .login-right {
    width: 480px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
  
    .login-card {
      width: 360px;
    
      h2 {
        text-align: center;
        margin-bottom: 32px;
        color: $text-primary;
      }
    
      .login-btn {
        width: 100%;
      }
    
      .footer-links {
        text-align: center;
        margin-top: 16px;
      
        a {
          color: $primary-color;
          text-decoration: none;
        
          &:hover {
            text-decoration: underline;
          }
        }
      }
    }
  }
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(180deg); }
}
</style>
```

##### 2.5.2 Dashboard

```vue
<!-- src/views/dashboard/DashboardView.vue -->
<template>
  <div class="dashboard">
    <!-- KPIå¡ç‰‡ -->
    <el-row :gutter="16" class="kpi-row">
      <el-col :xs="24" :sm="12" :md="6" v-for="kpi in kpis" :key="kpi.title">
        <DataCard
          :title="kpi.title"
          :main-value="kpi.value"
          :trend="kpi.trend"
          :label="kpi.label"
          :icon="kpi.icon"
          :icon-color="kpi.color"
        />
      </el-col>
    </el-row>
  
    <!-- å›¾è¡¨åŒºåŸŸ -->
    <el-row :gutter="16" class="chart-row">
      <el-col :xs="24" :md="12">
        <el-card title="ä¸“ä¸šåˆ†å¸ƒ">
          <PieChart :data="specialtyData" />
        </el-card>
      </el-col>
    
      <el-col :xs="24" :md="12">
        <el-card title="æœˆåº¦è¶‹åŠ¿">
          <LineChart :data="trendData" />
        </el-card>
      </el-col>
    </el-row>
  
    <!-- å¿«é€Ÿæ“ä½œ -->
    <el-row class="action-row">
      <el-button type="primary" size="large" @click="startAnalysis">
        <el-icon><DataAnalysis /></el-icon>
        å¼€å§‹æ–°åˆ†æ
      </el-button>
      <el-button size="large" @click="viewReports">
        <el-icon><Document /></el-icon>
        æŸ¥çœ‹æŠ¥å‘Š
      </el-button>
    </el-row>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { doctorAPI } from '@/api/doctor'
import DataCard from '@/components/common/DataCard.vue'
import PieChart from '@/components/charts/PieChart.vue'
import LineChart from '@/components/charts/LineChart.vue'

const router = useRouter()

const kpis = ref([
  {
    title: 'æ€»åŒ»ç”Ÿæ•°',
    value: '738,772',
    trend: 2.3,
    label: 'è¾ƒä¸Šæœˆ',
    icon: 'User',
    color: '#1890FF'
  },
  {
    title: 'æ€»é‡‘é¢',
    value: '$2.50B',
    trend: 5.1,
    label: 'è¾ƒä¸Šæœˆ',
    icon: 'Money',
    color: '#52C41A'
  },
  {
    title: 'å¹³å‡é‡‘é¢',
    value: '$3,377',
    trend: 1.8,
    label: 'è¾ƒä¸Šæœˆ',
    icon: 'TrendCharts',
    color: '#FAAD14'
  },
  {
    title: 'æœ€è¿‘åˆ†æ',
    value: '2å°æ—¶å‰',
    trend: 0,
    label: 'K=3èšç±»',
    icon: 'Clock',
    color: '#13C2C2'
  }
])

const specialtyData = ref([])
const trendData = ref([])

onMounted(async () => {
  const stats = await doctorAPI.getStatistics()
  // å¤„ç†æ•°æ®...
})

const startAnalysis = () => {
  router.push('/analysis')
}

const viewReports = () => {
  router.push('/reports')
}
</script>
```

##### 2.5.3 èšç±»åˆ†æé¡µ

```vue
<!-- src/views/analysis/ClusterAnalysisView.vue -->
<template>
  <div class="analysis-view">
    <el-row :gutter="16">
      <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
      <el-col :xs="24" :md="6">
        <el-card title="èšç±»é…ç½®">
          <el-form :model="config" label-width="80px">
            <el-form-item label="Kå€¼">
              <el-slider
                v-model="config.k"
                :min="2"
                :max="10"
                :marks="{ 2: '2', 3: '3', 5: '5', 10: '10' }"
                show-stops
              />
            </el-form-item>
          
            <el-form-item label="ç‰¹å¾é€‰æ‹©">
              <el-checkbox-group v-model="config.features">
                <el-checkbox label="rfm_frequency">é¢‘æ¬¡</el-checkbox>
                <el-checkbox label="rfm_monetary">é‡‘é¢</el-checkbox>
              </el-checkbox-group>
            </el-form-item>
          
            <el-form-item>
              <el-button
                type="primary"
                :loading="analysisStore.isAnalyzing"
                @click="handleStartAnalysis"
                block
              >
                {{ analysisStore.isAnalyzing ? 'åˆ†æä¸­...' : 'å¼€å§‹åˆ†æ' }}
              </el-button>
            
              <el-button @click="viewHistory" block>æŸ¥çœ‹å†å²</el-button>
            </el-form-item>
          </el-form>
        </el-card>
      </el-col>
    
      <!-- å³ä¾§ç»“æœå±•ç¤º -->
      <el-col :xs="24" :md="18">
        <!-- åˆ†æä¸­çŠ¶æ€ -->
        <div v-if="analysisStore.isAnalyzing" class="analyzing">
          <el-progress
            :percentage="progress"
            :format="() => `åˆ†æè¿›åº¦: ${progress}%`"
          />
          <p class="tip">æ­£åœ¨æ‰§è¡ŒK-Meansèšç±»ç®—æ³•...</p>
        </div>
      
        <!-- ç»“æœå±•ç¤º -->
        <div v-else-if="analysisStore.clusterResults">
          <!-- è¯„ä¼°æŒ‡æ ‡ -->
          <el-row :gutter="16" class="metrics-row">
            <el-col :span="12">
              <el-statistic
                title="è½®å»“ç³»æ•°"
                :value="analysisStore.clusterResults.silhouette_score"
                :precision="3"
              />
            </el-col>
            <el-col :span="12">
              <el-statistic
                title="æƒ¯æ€§"
                :value="analysisStore.clusterResults.inertia"
                :precision="2"
              />
            </el-col>
          </el-row>
        
          <!-- å›¾è¡¨ -->
          <el-tabs v-model="activeTab">
            <el-tab-pane label="3Dæ•£ç‚¹å›¾" name="scatter">
              <ScatterChart3D :data="scatterData" />
            </el-tab-pane>
          
            <el-tab-pane label="é›·è¾¾å›¾" name="radar">
              <RadarChart :data="radarData" />
            </el-tab-pane>
          
            <el-tab-pane label="ç»Ÿè®¡è¡¨" name="table">
              <el-table :data="tableData" stripe>
                <el-table-column prop="cluster_id" label="èšç±»ID" width="80" />
                <el-table-column prop="label" label="æ ‡ç­¾" width="120" />
                <el-table-column prop="size" label="è§„æ¨¡" sortable />
                <el-table-column prop="avg_monetary" label="å¹³å‡é‡‘é¢" sortable>
                  <template #default="{ row }">
                    ${{ row.avg_monetary.toLocaleString() }}
                  </template>
                </el-table-column>
                <el-table-column prop="avg_frequency" label="å¹³å‡é¢‘æ¬¡" sortable />
              </el-table>
            </el-tab-pane>
          </el-tabs>
        
          <!-- æ“ä½œæŒ‰é’® -->
          <div class="action-bar">
            <el-button type="primary" @click="generateReport">
              <el-icon><Document /></el-icon>
              ç”ŸæˆAIæŠ¥å‘Š
            </el-button>
            <el-button @click="exportData">
              <el-icon><Download /></el-icon>
              å¯¼å‡ºæ•°æ®
            </el-button>
          </div>
        </div>
      
        <!-- ç©ºçŠ¶æ€ -->
        <el-empty v-else description="è¯·é…ç½®å‚æ•°å¹¶å¼€å§‹åˆ†æ" />
      </el-col>
    </el-row>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useAnalysisStore } from '@/store/analysis'
import { ElMessage } from 'element-plus'
import ScatterChart3D from '@/components/charts/ScatterChart3D.vue'
import RadarChart from '@/components/charts/RadarChart.vue'

const router = useRouter()
const analysisStore = useAnalysisStore()

const config = reactive({
  k: 3,
  features: ['rfm_frequency', 'rfm_monetary']
})

const progress = ref(0)
const activeTab = ref('scatter')

const handleStartAnalysis = async () => {
  try {
    // æ¨¡æ‹Ÿè¿›åº¦
    const interval = setInterval(() => {
      if (progress.value < 90) {
        progress.value += 10
      }
    }, 500)
  
    await analysisStore.startClustering(config.k, config.features)
  
    clearInterval(interval)
    progress.value = 100
    ElMessage.success('åˆ†æå®Œæˆï¼')
  } catch (error) {
    ElMessage.error('åˆ†æå¤±è´¥')
  }
}

const generateReport = () => {
  router.push({
    name: 'ReportGenerate',
    query: { cluster_id: analysisStore.clusterResults.cluster_id }
  })
}
</script>
```

##### 2.5.4 AIæŠ¥å‘Šç”Ÿæˆé¡µ

```vue
<!-- src/views/report/ReportGenerateView.vue -->
<template>
  <div class="report-generate">
    <el-row :gutter="16">
      <!-- ä¸»å¯¹è¯åŒº -->
      <el-col :xs="24" :md="18">
        <el-card class="chat-card">
          <template #header>
            <div class="header">
              <el-avatar :size="32">ğŸ¤–</el-avatar>
              <span class="title">AI åˆ†æåŠ©æ‰‹</span>
            </div>
          </template>
        
          <!-- æ¶ˆæ¯åˆ—è¡¨ -->
          <div class="message-list" ref="messageListRef">
            <div
              v-for="(msg, index) in messages"
              :key="index"
              class="message"
              :class="msg.role"
            >
              <el-avatar :size="40">
                {{ msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–' }}
              </el-avatar>
            
              <div class="content">
                <!-- ç”¨æˆ·æ¶ˆæ¯ -->
                <div v-if="msg.role === 'user'" class="text">
                  {{ msg.content }}
                </div>
              
                <!-- AIæ¶ˆæ¯ï¼ˆMarkdownæ¸²æŸ“ï¼‰ -->
                <div v-else class="markdown-body">
                  <MarkdownRenderer :content="msg.content" />
                
                  <!-- å†…åµŒå›¾è¡¨ -->
                  <div v-if="msg.charts" class="charts">
                    <component
                      v-for="(chart, i) in msg.charts"
                      :key="i"
                      :is="chart.type"
                      :data="chart.data"
                    />
                  </div>
                </div>
              </div>
            </div>
          
            <!-- åŠ è½½ä¸­ -->
            <div v-if="isGenerating" class="message assistant">
              <el-avatar :size="40">ğŸ¤–</el-avatar>
              <div class="content">
                <StreamingText :content="currentStream" />
              </div>
            </div>
          </div>
        
          <!-- è¾“å…¥æ¡† -->
          <div class="input-area">
            <el-input
              v-model="userInput"
              type="textarea"
              :rows="3"
              placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚..."
              @keydown.enter.ctrl="handleSend"
            />
            <el-button
              type="primary"
              :loading="isGenerating"
              :disabled="!userInput.trim()"
              @click="handleSend"
            >
              å‘é€ (Ctrl+Enter)
            </el-button>
          </div>
        </el-card>
      </el-col>
    
      <!-- ä¾§è¾¹æ  -->
      <el-col :xs="24" :md="6">
        <!-- å¿«é€Ÿæ¨¡æ¿ -->
        <el-card title="å¿«é€Ÿæ¨¡æ¿">
          <el-button
            v-for="template in templates"
            :key="template.id"
            text
            @click="useTemplate(template.content)"
            class="template-btn"
          >
            {{ template.title }}
          </el-button>
        </el-card>
      
        <!-- å†å²å¯¹è¯ -->
        <el-card title="å†å²æŠ¥å‘Š" class="history-card">
          <el-timeline>
            <el-timeline-item
              v-for="report in recentReports"
              :key="report.id"
              :timestamp="report.created_at"
            >
              <el-link @click="loadReport(report.id)">
                {{ report.title }}
              </el-link>
            </el-timeline-item>
          </el-timeline>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, nextTick } from 'vue'
import { useRoute } from 'vue-router'
import { reportAPI } from '@/api/report'
import MarkdownRenderer from '@/components/report/MarkdownRenderer.vue'
import StreamingText from '@/components/report/StreamingText.vue'
import { SSEClient } from '@/utils/sse'

const route = useRoute()

const messages = ref<any[]>([])
const userInput = ref('')
const isGenerating = ref(false)
const currentStream = ref('')
const messageListRef = ref()

const templates = ref([
  { id: 1, title: 'åˆ†ææ ¸å¿ƒå®¢æˆ·ç¾¤', content: 'è¯·åˆ†ææ ¸å¿ƒå®¢æˆ·ç¾¤çš„ç‰¹å¾å’Œè¥é”€ç­–ç•¥' },
  { id: 2, title: 'å¯¹æ¯”å„èšç±»', content: 'è¯·å¯¹æ¯”å„ä¸ªèšç±»çš„å·®å¼‚' },
  { id: 3, title: 'ç”Ÿæˆå®Œæ•´æŠ¥å‘Š', content: 'è¯·ç”Ÿæˆä¸€ä»½å®Œæ•´çš„å¸‚åœºåˆ†ææŠ¥å‘Š' }
])

const recentReports = ref([])

onMounted(async () => {
  // åŠ è½½å†å²æŠ¥å‘Š
  const data = await reportAPI.getReports({ page: 1, page_size: 5 })
  recentReports.value = data.items
  
  // å¦‚æœæœ‰cluster_idå‚æ•°ï¼Œè‡ªåŠ¨å¼€å§‹åˆ†æ
  if (route.query.cluster_id) {
    userInput.value = 'è¯·åˆ†æè¿™ä¸ªèšç±»çš„ç‰¹å¾'
    handleSend()
  }
})

const handleSend = async () => {
  if (!userInput.value.trim() || isGenerating.value) return
  
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  messages.value.push({
    role: 'user',
    content: userInput.value
  })
  
  const query = userInput.value
  userInput.value = ''
  
  // å¼€å§‹ç”Ÿæˆ
  isGenerating.value = true
  currentStream.value = ''
  
  try {
    // è°ƒç”¨ç”ŸæˆAPI
    const { report_id, stream_url } = await reportAPI.generateReport({
      report_type: 'cluster_analysis',
      cluster_id: Number(route.query.cluster_id),
      custom_prompt: query
    })
  
    // å»ºç«‹SSEè¿æ¥
    const sseClient = new SSEClient()
    sseClient.connect(stream_url, (chunk) => {
      currentStream.value += chunk
      scrollToBottom()
    })
  
    sseClient.onComplete(() => {
      messages.value.push({
        role: 'assistant',
        content: currentStream.value
      })
      currentStream.value = ''
      isGenerating.value = false
    })
  } catch (error) {
    isGenerating.value = false
    ElMessage.error('ç”Ÿæˆå¤±è´¥')
  }
}

const scrollToBottom = () => {
  nextTick(() => {
    messageListRef.value?.scrollTo({
      top: messageListRef.value.scrollHeight,
      behavior: 'smooth'
    })
  })
}

const useTemplate = (content: string) => {
  userInput.value = content
}
</script>

<style scoped lang="scss">
.report-generate {
  .chat-card {
    height: calc(100vh - 180px);
    display: flex;
    flex-direction: column;
  
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
    
      .title {
        font-size: 18px;
        font-weight: 600;
      }
    }
  
    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    
      .message {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
      
        &.user {
          flex-direction: row-reverse;
        
          .content {
            background: $primary-color;
            color: white;
            border-radius: 16px 16px 0 16px;
          }
        }
      
        &.assistant {
          .content {
            background: $bg-color;
            border-radius: 16px 16px 16px 0;
          }
        }
      
        .content {
          flex: 1;
          padding: 16px;
          max-width: 80%;
        }
      }
    }
  
    .input-area {
      display: flex;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid $border-color;
    }
  }
  
  .template-btn {
    display: block;
    width: 100%;
    text-align: left;
    margin-bottom: 8px;
  }
}
</style>
```

---

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šå…³é”®å·¥å…·ä¸ç»„ä»¶

#### 3.1 SSEå®¢æˆ·ç«¯

```typescript
// src/utils/sse.ts
export class SSEClient {
  private eventSource: EventSource | null = null
  private onCompleteCallback: (() => void) | null = null
  
  connect(url: string, onMessage: (data: string) => void) {
    this.eventSource = new EventSource(url)
  
    this.eventSource.onmessage = (event) => {
      if (event.data === '[DONE]') {
        this.close()
        this.onCompleteCallback?.()
        return
      }
      onMessage(event.data)
    }
  
    this.eventSource.onerror = (error) => {
      console.error('SSE Error:', error)
      this.close()
    }
  }
  
  onComplete(callback: () => void) {
    this.onCompleteCallback = callback
  }
  
  close() {
    this.eventSource?.close()
    this.eventSource = null
  }
}
```

#### 3.2 Markdownæ¸²æŸ“ç»„ä»¶

```vue
<!-- src/components/report/MarkdownRenderer.vue -->
<template>
  <div class="markdown-body" v-html="renderedHTML"></div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import MarkdownIt from 'markdown-it'
import hljs from 'highlight.js'

const props = defineProps<{
  content: string
}>()

const md = new MarkdownIt({
  highlight: (str, lang) => {
    if (lang && hljs.getLanguage(lang)) {
      try {
        return hljs.highlight(str, { language: lang }).value
      } catch {}
    }
    return ''
  }
})

const renderedHTML = computed(() => {
  return md.render(props.content)
})
</script>

<style>
@import 'highlight.js/styles/github.css';
@import 'github-markdown-css/github-markdown.css';
</style>
```

#### 3.3 ECharts 3Dæ•£ç‚¹å›¾ç»„ä»¶

```vue
<!-- src/components/charts/ScatterChart3D.vue -->
<template>
  <div ref="chartRef" class="chart-container"></div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue'
import * as echarts from 'echarts'
import 'echarts-gl'

const props = defineProps<{
  data: any[]
}>()

const chartRef = ref()
let chartInstance: echarts.ECharts | null = null

const initChart = () => {
  if (!chartRef.value) return
  
  chartInstance = echarts.init(chartRef.value)
  
  const option = {
    tooltip: {
      formatter: (params: any) => `
        <div style="padding: 8px;">
          <strong>${params.name}</strong><br/>
          é¢‘æ¬¡: ${params.value[0]}<br/>
          é‡‘é¢: ${params.value[1].toLocaleString()}<br/>
          èšç±»: ${params.value[3]}
        </div>
      `
    },
    grid3D: {
      viewControl: {
        autoRotate: true,
        autoRotateSpeed: 5,
        distance: 200
      },
      light: {
        main: {
          intensity: 1.2,
          shadow: true
        },
        ambient: {
          intensity: 0.3
        }
      }
    },
    xAxis3D: {
      name: 'Frequency',
      type: 'value'
    },
    yAxis3D: {
      name: 'Monetary ($)',
      type: 'log',
      logBase: 10
    },
    zAxis3D: {
      name: 'Recency',
      type: 'value'
    },
    series: [{
      type: 'scatter3D',
      data: props.data,
      symbolSize: 5,
      itemStyle: {
        opacity: 0.7
      },
      emphasis: {
        itemStyle: {
          opacity: 1,
          borderWidth: 2,
          borderColor: '#fff'
        }
      }
    }]
  }
  
  chartInstance.setOption(option)
}

onMounted(() => {
  initChart()
  window.addEventListener('resize', () => {
    chartInstance?.resize()
  })
})

watch(() => props.data, () => {
  chartInstance?.setOption({
    series: [{ data: props.data }]
  })
})
</script>

<style scoped>
.chart-container {
  width: 100%;
  height: 500px;
}
</style>
```

---

## ğŸ“ å¼€å‘æ£€æŸ¥æ¸…å•

### åç«¯å¼€å‘æ¸…å•

- [ ] **Phase 1: åŸºç¡€æ¶æ„**

  - [ ] FastAPIé¡¹ç›®åˆå§‹åŒ–
  - [ ] SQLAlchemyæ¨¡å‹å®šä¹‰ï¼ˆ7å¼ è¡¨ï¼‰
  - [ ] æ•°æ®åº“è¿ç§»è„šæœ¬
  - [ ] JWTè®¤è¯ç³»ç»Ÿ
  - [ ] å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶
  - [ ] CORSé…ç½®
- [ ] **Phase 2: æ ¸å¿ƒAPI**

  - [ ] ç”¨æˆ·è®¤è¯APIï¼ˆæ³¨å†Œã€ç™»å½•ã€è·å–ä¿¡æ¯ï¼‰
  - [ ] åŒ»ç”Ÿæ•°æ®APIï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ã€ç»Ÿè®¡ï¼‰
  - [ ] åˆ†æä»»åŠ¡APIï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€çŠ¶æ€ï¼‰
  - [ ] AIæŠ¥å‘ŠAPIï¼ˆç”Ÿæˆã€æŸ¥è¯¢ã€æµå¼è¾“å‡ºï¼‰
  - [ ] ç®¡ç†APIï¼ˆç”¨æˆ·ç®¡ç†ã€æ—¥å¿—ï¼‰
- [ ] **Phase 3: ä¸šåŠ¡æœåŠ¡**

  - [ ] K-Meansèšç±»æœåŠ¡
  - [ ] Difyé›†æˆæœåŠ¡
  - [ ] æ•°æ®å¯¼å‡ºæœåŠ¡
  - [ ] ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
- [ ] **Phase 4: æµ‹è¯•ä¸æ–‡æ¡£**

  - [ ] å•å…ƒæµ‹è¯•ï¼ˆpytestï¼‰
  - [ ] APIæ–‡æ¡£ï¼ˆSwaggerè‡ªåŠ¨ç”Ÿæˆï¼‰
  - [ ] æ€§èƒ½æµ‹è¯•
  - [ ] Dockeré•œåƒæ„å»º

### å‰ç«¯å¼€å‘æ¸…å•

- [ ] **Phase 1: é¡¹ç›®æ­å»º**

  - [ ] Vite + Vue3 + TypeScriptåˆå§‹åŒ–
  - [ ] è·¯ç”±é…ç½®
  - [ ] PiniaçŠ¶æ€ç®¡ç†
  - [ ] Axioså°è£…
  - [ ] Element Plusé…ç½®
- [ ] **Phase 2: åŸºç¡€é¡µé¢**

  - [ ] ç™»å½•/æ³¨å†Œé¡µ
  - [ ] ä¸»å¸ƒå±€ï¼ˆä¾§è¾¹æ +é¡¶æ ï¼‰
  - [ ] Dashboard
  - [ ] 404é¡µé¢
- [ ] **Phase 3: æ ¸å¿ƒåŠŸèƒ½**

  - [ ] åŒ»ç”Ÿåˆ—è¡¨é¡µï¼ˆè¡¨æ ¼ã€ç­›é€‰ã€åˆ†é¡µï¼‰
  - [ ] åŒ»ç”Ÿè¯¦æƒ…é¡µ
  - [ ] èšç±»åˆ†æé¡µï¼ˆé…ç½®ã€å¯è§†åŒ–ï¼‰
  - [ ] AIæŠ¥å‘Šç”Ÿæˆé¡µï¼ˆå¯¹è¯å¼ï¼‰
  - [ ] æŠ¥å‘Šåˆ—è¡¨ä¸è¯¦æƒ…
- [ ] **Phase 4: é«˜çº§ç»„ä»¶**

  - [ ] EChartså›¾è¡¨ç»„ä»¶ï¼ˆæ•£ç‚¹å›¾ã€é›·è¾¾å›¾ã€æŠ˜çº¿å›¾ï¼‰
  - [ ] Markdownæ¸²æŸ“ç»„ä»¶
  - [ ] SSEæµå¼ç»„ä»¶
  - [ ] æ•°æ®å¯¼å‡ºç»„ä»¶
- [ ] **Phase 5: ä¼˜åŒ–ä¸æµ‹è¯•**

  - [ ] å“åº”å¼é€‚é…
  - [ ] åŠ¨ç”»æ•ˆæœ
  - [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‡’åŠ è½½ã€è™šæ‹Ÿæ»šåŠ¨ï¼‰
  - [ ] E2Eæµ‹è¯•ï¼ˆCypressï¼‰

### Difyé…ç½®æ¸…å•

- [ ] **å·¥ä½œæµè®¾è®¡**

  - [ ] ä»»åŠ¡è§„åˆ’èŠ‚ç‚¹
  - [ ] æ•°æ®åˆ†æèŠ‚ç‚¹
  - [ ] å¯è§†åŒ–ç”ŸæˆèŠ‚ç‚¹
  - [ ] æŠ¥å‘Šæ’°å†™èŠ‚ç‚¹
- [ ] **å·¥å…·å¼€å‘**

  - [ ] æ•°æ®åº“æŸ¥è¯¢å·¥å…·
  - [ ] K-Meansæ¨¡å‹è°ƒç”¨å·¥å…·
  - [ ] å›¾è¡¨ç”Ÿæˆå·¥å…·
- [ ] **çŸ¥è¯†åº“æ„å»º**

  - [ ] åŒ»è¯è¡Œä¸šçŸ¥è¯†åº“
  - [ ] è¥é”€ç­–ç•¥æ¨¡æ¿åº“
  - [ ] å¸¸è§é—®é¢˜åº“

---

## ğŸš€ å¼€å‘æœ€ä½³å®è·µ

### 1. ä»£ç è§„èŒƒ

- ä½¿ç”¨Prettieræ ¼å¼åŒ–ä»£ç 
- ä½¿ç”¨ESLintæ£€æŸ¥ä»£ç è´¨é‡
- éµå¾ªPython PEP8è§„èŒƒ
- TypeScriptä¸¥æ ¼æ¨¡å¼

### 2. Gitå·¥ä½œæµ

```bash
# åŠŸèƒ½åˆ†æ”¯å¼€å‘
git checkout -b feature/user-auth
# æäº¤æ ¼å¼
git commit -m "feat: å®ç°ç”¨æˆ·è®¤è¯åŠŸèƒ½"
git commit -m "fix: ä¿®å¤ç™»å½•é¡µæ ·å¼é—®é¢˜"
git commit -m "docs: æ›´æ–°APIæ–‡æ¡£"
```

### 3. ç¯å¢ƒå˜é‡ç®¡ç†

```env
# backend/.env
DATABASE_URL=sqlite:///./pharma.db
SECRET_KEY=your-secret-key-change-in-production
DIFY_API_KEY=your-dify-api-key
DIFY_WORKFLOW_ID=your-workflow-id

# frontend/.env.development
VITE_API_BASE_URL=http://localhost:8000/api/v1

# frontend/.env.production
VITE_API_BASE_URL=https://api.example.com/api/v1
```

### 4. Dockeréƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=sqlite:///./pharma.db
      - DIFY_API_KEY=${DIFY_API_KEY}
    volumes:
      - ./backend/pharma.db:/app/pharma.db
  
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
```

---

## âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šCORSè·¨åŸŸé”™è¯¯

**è§£å†³**ï¼šåœ¨FastAPIä¸­é…ç½®CORSä¸­é—´ä»¶

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### é—®é¢˜2ï¼šSQLiteå¹¶å‘å†™å…¥é”™è¯¯

**è§£å†³**ï¼šä½¿ç”¨WALæ¨¡å¼æˆ–è¿ç§»åˆ°PostgreSQL

```python
# database.py
engine = create_engine(
    "sqlite:///./pharma.db",
    connect_args={"check_same_thread": False, "timeout": 30}
)
```

### é—®é¢˜3ï¼šå¤§æ•°æ®é‡å¯¼è‡´å‰ç«¯å¡é¡¿

**è§£å†³**ï¼š

- åç«¯å®ç°åˆ†é¡µ
- å‰ç«¯ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆvue-virtual-scrollerï¼‰
- å›¾è¡¨æ•°æ®é‡‡æ ·ï¼ˆæ˜¾ç¤º1000ä¸ªç‚¹è€Œä¸æ˜¯å…¨éƒ¨ï¼‰

### é—®é¢˜4ï¼šDify APIè¶…æ—¶

**è§£å†³**ï¼š

- å¢åŠ httpxçš„timeouté…ç½®
- å®ç°å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCeleryï¼‰
- æ·»åŠ é‡è¯•æœºåˆ¶

---

## ğŸ“š å­¦ä¹ èµ„æº

### åç«¯ç›¸å…³

- [FastAPIå®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemyæ•™ç¨‹](https://www.sqlalchemy.org/library.html)
- [K-Meansç®—æ³•è¯¦è§£](https://scikit-learn.org/stable/modules/clustering.html)

### å‰ç«¯ç›¸å…³

- [Vue3å®˜æ–¹æ–‡æ¡£](https://vuejs.org/)
- [Element Plusç»„ä»¶åº“](https://element-plus.org/)
- [EChartsç¤ºä¾‹](https://echarts.apache.org/examples/)

### Difyç›¸å…³

- [Difyå®˜æ–¹æ–‡æ¡£](https://docs.dify.ai/)
- [å·¥ä½œæµæœ€ä½³å®è·µ](https://docs.dify.ai/guides/workflow)

---

## ğŸ‰ å®Œæˆæ ‡å‡†

å½“ä½ å®Œæˆä»¥ä¸‹æ‰€æœ‰åŠŸèƒ½æ—¶ï¼Œå³å¯äº¤ä»˜é¡¹ç›®ï¼š

âœ… **ç”¨æˆ·å¯ä»¥æ³¨å†Œç™»å½•**
âœ… **å¯ä»¥æŸ¥çœ‹å’Œç­›é€‰åŒ»ç”Ÿæ•°æ®**
âœ… **å¯ä»¥æ‰§è¡ŒK-Meansèšç±»åˆ†æå¹¶çœ‹åˆ°å¯è§†åŒ–ç»“æœ**
âœ… **å¯ä»¥é€šè¿‡å¯¹è¯ç”ŸæˆAIæŠ¥å‘Šï¼ˆæµå¼è¾“å‡ºï¼‰**
âœ… **æŠ¥å‘ŠåŒ…å«Markdownæ ¼å¼æ–‡æœ¬å’Œå†…åµŒå›¾è¡¨**
âœ… **ç³»ç»Ÿè¿è¡Œç¨³å®šï¼Œæ— é‡å¤§Bug**
âœ… **ä»£ç æ³¨é‡Šæ¸…æ™°ï¼Œæœ‰APIæ–‡æ¡£**
âœ… **é€šè¿‡Dockerä¸€é”®éƒ¨ç½²**
