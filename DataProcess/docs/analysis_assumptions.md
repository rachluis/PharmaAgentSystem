# 基于毕设内容假设的 Task 1 分析

**【注意】此分析是基于对医药行业数据的通用经验进行的假设。最终的字段名和清洗策略必须根据实际生成的 `data_report.txt` 进行微调。**

## Task 1.1: 推荐特征与 RFM 逻辑

我们假设数据中包含以下关键字段（或可通过计算获得）：

| 假设字段名                   | 字段描述                          | 目标变量                | 计算逻辑                                                                    |
| ---------------------------- | --------------------------------- | ----------------------- | --------------------------------------------------------------------------- |
| `Last_Prescription_Date`   | 最近一次开药/销售日期             | **R (Recency)**   | **R**值：计算当前日期到该日期的天数。天数越少，R 值越高。             |
| `Total_Prescription_Count` | 总处方数量/销售记录行数           | **F (Frequency)** | **F**值：统计医生在时间窗口内的总销售或处方次数。次数越多，F 值越高。 |
| `Total_Drug_Cost`          | 药品总销售额/总支付金额           | **M (Monetary)**  | **M**值：统计医生在其处方或被支付的总金额。金额越高，M 值越高。       |
| `Hospital_Tier`            | 医院等级/类型                     | 附加特征                | 分类变量，可用于聚类后的画像解读。                                          |
| `Payment_Amount`           | (来自 Open Payments) 药企支付金额 | 附加特征                | 表示医生受市场影响的程度。                                                  |

 **逻辑** ：通过上述 R、F、M 三个维度，我们可以将医生分成不同的群体：

* **高价值群体** ：R 值高（最近有交易），F 值高（交易频繁），M 值高（金额大）。
* **流失预警群体** ：R 值低（很久没交易），但 F 和 M 曾经高。
* **新星群体** ：R 值高，F/M 较低，但增长潜力大。

## Task 1.2: 清洗建议 (通用策略)

| 字段类型           | 发现问题                                                       | 通用清洗策略                                                                                                                                                   |
| ------------------ | -------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **日期字段** | (如 `Prescription_Date`) 格式不统一，可能存在缺失。          | **缺失处理** ：如果 R 值计算依赖该字段，缺失行直接删除。 **格式转换** ：统一转换为 `YYYY-MM-DD`格式。                                            |
| **金额字段** | (如 `Total_Drug_Cost`) 可能存在 `0`或空值，影响 M 值计算。 | **`0`值** ：如果是有效销售但金额为 0，可能为免费样品，可保留。如果大量为 0，需检查数据源。 **空值 (NaN)** ：如果是计算 M 值，空值应视为 0 填充。 |
| **ID 字段**  | (如 `Doctor_ID`或 `NPI`) 存在重复或缺失。                  | **缺失处理** ：ID 缺失的行数据无意义， **必须删除** 。 **重复处理** ：确保 ID 是唯一的医生标识符。                                           |
| **分类字段** | (如 `Specialty`) 唯一值过多或拼写不一致。                    | **归一化** ：将相似科室合并（如“内科 - 胃肠科”归一为“内科”）。使用 Label Encoding 或 One-Hot Encoding 转换为数值特征。                               |

## Task 1.3: 聚类结果结构 (发给 Dify AI 的数据)

聚类完成后，Dify Agent 需要的不是原始数据，而是 **高度精炼的群体总结** ，以便它生成精准的策略报告。

我们将保存一个 JSON 对象，结构如下：

```
{
  "cluster_id": 1, 
  "cluster_name": "高价值核心客户",
  "size_percentage": "25.3%", // 该群体占总医生的比例
  "kpi_summary": {
    "Avg_R_Days": 30, // 平均最近交易天数 (天数越少越好)
    "Avg_F_Count": 50, // 平均交易次数
    "Avg_M_Amount": 15000.00, // 平均交易金额
    "Top_Specialty": "心血管内科 (45%)", // 该群体中最多的科室
    "Top_Drug": "药物A, 药物B" // 该群体最常开的药物
  },
  "strategy_focus": "高频、高额客户。重点保持关系，推动新药试用，避免流失。",
  "context_for_llm": "基于此核心群体的高投入、高产出特点，策略应侧重于VIP服务和个性化医学会议邀请。"
}
```
